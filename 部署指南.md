# 萌友益站 - 部署指南

## 一、环境要求

### 1. 服务器环境
- **操作系统**: Linux (推荐 Ubuntu 20.04 或 CentOS 7+)
- **CPU**: 2核及以上
- **内存**: 4GB及以上
- **磁盘**: 50GB及以上

### 2. 软件环境
- **Java**: JDK 17
- **数据库**: MySQL 8.0
- **缓存**: Redis 6.0+
- **Web服务器**: Nginx 1.18+
- **Node.js**: 16.x+ (用于前端构建)

## 二、数据库部署

### 1. 安装MySQL

```bash
# Ubuntu
sudo apt update
sudo apt install mysql-server

# CentOS
sudo yum install mysql-server
```

### 2. 初始化数据库

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库并导入数据
source /path/to/database/init.sql

# 退出
exit
```

### 3. 创建数据库用户（可选）

```sql
CREATE USER 'mengyo'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON mengyo_db.* TO 'mengyo'@'localhost';
FLUSH PRIVILEGES;
```

## 三、后端部署

### 1. 构建后端项目

```bash
cd mengyo-backend
mvn clean package -DskipTests
```

### 2. 配置生产环境

编辑 `src/main/resources/application-prod.yml`:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/mengyo_db?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: mengyo
    password: your_password
    
  data:
    redis:
      host: localhost
      port: 6379
      password: your_redis_password

file:
  upload:
    path: /data/mengyo/upload/
    url-prefix: https://yourdomain.com/files/
```

### 3. 复制JAR文件

```bash
cp target/mengyo-backend-1.0.0.jar /workspace/public/backend/
```

### 4. 创建启动脚本

创建 `/workspace/public/backend/start.sh`:

```bash
#!/bin/bash
java -jar mengyo-backend-1.0.0.jar \
  --spring.profiles.active=prod \
  > logs/app.log 2>&1 &
  
echo $! > app.pid
echo "后端服务启动成功，PID: $(cat app.pid)"
```

### 5. 创建停止脚本

创建 `/workspace/public/backend/stop.sh`:

```bash
#!/bin/bash
if [ -f app.pid ]; then
  kill $(cat app.pid)
  rm app.pid
  echo "后端服务已停止"
else
  echo "未找到PID文件"
fi
```

### 6. 设置权限并启动

```bash
chmod +x start.sh stop.sh
./start.sh
```

## 四、管理后台部署

### 1. 安装依赖

```bash
cd mengyo-admin
npm install
```

### 2. 配置API地址

编辑 `src/utils/request.js`，修改 `BASE_URL`:

```javascript
const BASE_URL = 'https://yourdomain.com/api'
```

### 3. 构建项目

```bash
npm run build
```

### 4. 复制文件

```bash
cp -r dist/* /workspace/public/admin/
```

## 五、uni-app部署

### 1. 安装依赖

```bash
cd mengyo-uniapp
npm install
```

### 2. 配置API地址

编辑 `utils/request.js` 和 `utils/api.js`，修改 `BASE_URL`:

```javascript
const BASE_URL = 'https://yourdomain.com/api'
```

### 3. 构建H5版本

```bash
npm run build:h5
```

### 4. 复制文件

```bash
cp -r unpackage/dist/build/h5/* /workspace/public/uniapp/
```

### 5. 构建微信小程序（可选）

```bash
npm run build:mp-weixin
```

然后使用微信开发者工具打开 `unpackage/dist/build/mp-weixin` 目录上传。

## 六、Nginx配置

### 1. 安装Nginx

```bash
# Ubuntu
sudo apt install nginx

# CentOS
sudo yum install nginx
```

### 2. 配置站点

创建 `/etc/nginx/sites-available/mengyo.conf`:

```nginx
server {
    listen 80;
    server_name yourdomain.com;
    
    # 管理后台
    location /admin {
        alias /workspace/public/admin;
        try_files $uri $uri/ /admin/index.html;
        index index.html;
    }
    
    # uni-app H5版本
    location /app {
        alias /workspace/public/uniapp;
        try_files $uri $uri/ /app/index.html;
        index index.html;
    }
    
    # 本地文件访问
    location /files {
        alias /data/mengyo/upload/;
        expires 30d;
        access_log off;
    }
    
    # 后端API
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 文件上传大小限制
    client_max_body_size 20m;
}
```

### 3. 启用站点

```bash
# Ubuntu
sudo ln -s /etc/nginx/sites-available/mengyo.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# CentOS
sudo nginx -t
sudo systemctl reload nginx
```

## 七、SSL证书配置（HTTPS）

### 1. 使用Let's Encrypt免费证书

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d yourdomain.com
```

### 2. 自动续期

```bash
# 添加定时任务
sudo crontab -e

# 添加以下行（每天凌晨2点检查证书）
0 2 * * * /usr/bin/certbot renew --quiet
```

## 八、进程管理（使用PM2）

### 1. 安装PM2

```bash
npm install -g pm2
```

### 2. 使用PM2管理后端服务

创建 `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [{
    name: 'mengyo-backend',
    script: '/usr/bin/java',
    args: '-jar /workspace/public/backend/mengyo-backend-1.0.0.jar --spring.profiles.active=prod',
    cwd: '/workspace/public/backend',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

### 3. 启动服务

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

## 九、Redis配置

### 1. 安装Redis

```bash
# Ubuntu
sudo apt install redis-server

# CentOS
sudo yum install redis
```

### 2. 配置Redis

编辑 `/etc/redis/redis.conf`:

```conf
# 绑定地址
bind 127.0.0.1

# 设置密码
requirepass your_redis_password

# 持久化
save 900 1
save 300 10
save 60 10000
```

### 3. 启动Redis

```bash
sudo systemctl start redis
sudo systemctl enable redis
```

## 十、文件存储配置

### 1. 本地存储

```bash
# 创建上传目录
sudo mkdir -p /data/mengyo/upload
sudo chown -R www-data:www-data /data/mengyo
sudo chmod -R 755 /data/mengyo
```

### 2. 阿里云OSS（可选）

1. 登录阿里云控制台
2. 开通OSS服务
3. 创建Bucket
4. 获取AccessKey
5. 在管理后台配置OSS参数

## 十一、监控和日志

### 1. 查看后端日志

```bash
# PM2管理的服务
pm2 logs mengyo-backend

# 手动启动的服务
tail -f /workspace/public/backend/logs/app.log
```

### 2. 查看Nginx日志

```bash
# 访问日志
tail -f /var/log/nginx/access.log

# 错误日志
tail -f /var/log/nginx/error.log
```

### 3. 监控服务状态

```bash
# PM2监控
pm2 monit

# 查看进程
pm2 status
```

## 十二、备份策略

### 1. 数据库备份

创建备份脚本 `/workspace/backup/backup-db.sh`:

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/workspace/backup/db"
mkdir -p $BACKUP_DIR

mysqldump -u mengyo -p'your_password' mengyo_db > $BACKUP_DIR/mengyo_db_$DATE.sql
gzip $BACKUP_DIR/mengyo_db_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

### 2. 定时备份

```bash
sudo crontab -e

# 每天凌晨3点备份
0 3 * * * /workspace/backup/backup-db.sh
```

## 十三、安全建议

1. **防火墙配置**
   ```bash
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw enable
   ```

2. **定期更新**
   ```bash
   sudo apt update
   sudo apt upgrade
   ```

3. **修改默认密码**
   - 数据库密码
   - Redis密码
   - 管理员账号密码

4. **限制SSH访问**
   - 禁用root登录
   - 使用SSH密钥认证
   - 修改SSH端口

5. **配置日志轮转**
   创建 `/etc/logrotate.d/mengyo`:
   ```
   /workspace/public/backend/logs/*.log {
       daily
       rotate 30
       compress
       delaycompress
       missingok
       notifempty
   }
   ```

## 十四、故障排查

### 1. 后端服务无法启动

- 检查Java版本: `java -version`
- 检查端口占用: `netstat -tulpn | grep 8080`
- 查看日志: `tail -f logs/app.log`

### 2. 数据库连接失败

- 检查MySQL服务: `systemctl status mysql`
- 检查连接配置: `application-prod.yml`
- 测试连接: `mysql -u mengyo -p mengyo_db`

### 3. Nginx无法访问

- 检查Nginx状态: `systemctl status nginx`
- 检查配置语法: `nginx -t`
- 查看错误日志: `tail -f /var/log/nginx/error.log`

## 十五、更新部署

```bash
# 1. 备份数据库
/workspace/backup/backup-db.sh

# 2. 停止服务
pm2 stop mengyo-backend

# 3. 更新代码
git pull origin main

# 4. 构建后端
cd mengyo-backend
mvn clean package -DskipTests
cp target/mengyo-backend-1.0.0.jar /workspace/public/backend/

# 5. 构建前端
cd ../mengyo-admin
npm install
npm run build
cp -r dist/* /workspace/public/admin/

# 6. 重启服务
pm2 restart mengyo-backend

# 7. 重载Nginx
sudo nginx -s reload
```

## 十六、性能优化

1. **数据库优化**
   - 添加适当的索引
   - 配置连接池
   - 定期优化表

2. **Redis缓存**
   - 缓存热点数据
   - 设置合理的过期时间

3. **静态资源**
   - 开启Gzip压缩
   - 配置CDN加速
   - 设置浏览器缓存

4. **后端优化**
   - 调整JVM参数
   - 开启异步处理
   - 使用连接池

## 十七、联系方式

如有问题，请联系技术支持：
- 邮箱: support@mengyo.com
- 文档: https://docs.mengyo.com
