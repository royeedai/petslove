# 文件上传功能说明

## 功能概述

系统已实现完整的文件上传功能，支持本地存储和阿里云OSS两种存储方式，可在管理后台自由切换。

## 一、后端实现

### 1. 依赖配置

已在 `pom.xml` 中添加阿里云OSS SDK依赖：

```xml
<dependency>
    <groupId>com.aliyun.oss</groupId>
    <artifactId>aliyun-sdk-oss</artifactId>
    <version>3.17.4</version>
</dependency>
```

### 2. 配置文件

在 `application-dev.yml` 中配置文件上传参数：

```yaml
file:
  upload:
    # 本地存储路径
    path: /data/mengyo/upload/
    # 访问URL前缀
    url-prefix: http://localhost:8080/api/files/
```

### 3. 核心类说明

#### FileUploadConfig.java
文件上传配置类，从配置文件和数据库读取配置信息。

#### FileUploadService.java
文件上传服务接口，提供以下方法：
- `uploadFile(MultipartFile file)` - 上传文件
- `uploadImage(MultipartFile file)` - 上传图片
- `deleteFile(String fileUrl)` - 删除文件
- `getStorageType()` - 获取当前存储类型

#### FileUploadController.java
文件上传控制器，提供以下接口：
- `POST /system/file/upload` - 上传文件
- `POST /system/file/upload/image` - 上传图片
- `DELETE /system/file/delete` - 删除文件
- `GET /system/file/storage-type` - 获取存储类型

### 4. 支持的文件格式

- **图片**: jpg, jpeg, png, gif, bmp, webp
- **文档**: pdf, doc, docx, xls, xlsx, ppt, pptx
- **压缩包**: zip, rar, 7z
- **视频**: mp4, avi, mov

### 5. 文件大小限制

- 单个文件最大 10MB
- 可在 `application.yml` 中调整：
  ```yaml
  spring:
    servlet:
      multipart:
        max-file-size: 10MB
        max-request-size: 20MB
  ```

## 二、管理后台配置

### 1. 系统配置页面

路径：`mengyo-admin/src/views/system/config.vue`

功能：
- 基础配置管理（网站名称、Logo、联系方式等）
- 积分配置管理
- **存储配置管理**（本地/OSS切换）

### 2. 存储方式切换

在系统配置页面可以选择存储方式：

#### 本地存储
- 默认配置，无需额外设置
- 文件保存在服务器本地路径

#### 阿里云OSS
需要配置以下参数：
- **AccessKeyId**: 阿里云访问密钥ID
- **AccessKeySecret**: 阿里云访问密钥密码
- **Endpoint**: OSS服务端点（如：oss-cn-shenzhen.aliyuncs.com）
- **Bucket名称**: OSS存储桶名称
- **访问域名**: 自定义域名（可选）

### 3. 文件上传组件

路径：`mengyo-admin/src/components/FileUpload.vue`

使用示例：
```vue
<template>
  <FileUpload
    v-model="imageUrl"
    upload-type="image"
    :multiple="false"
    :limit="1"
  />
</template>

<script setup>
import { ref } from 'vue'
import FileUpload from '@/components/FileUpload.vue'

const imageUrl = ref('')
</script>
```

## 三、uni-app端使用

### 1. API接口

路径：`mengyo-uniapp/utils/api.js`

提供以下方法：
- `fileApi.uploadImage(filePath)` - 上传图片
- `fileApi.uploadFile(filePath)` - 上传文件

### 2. 工具函数

路径：`mengyo-uniapp/utils/upload.js`

提供以下工具函数：
- `chooseAndUploadImage(options)` - 选择并上传多张图片
- `chooseAndUploadSingleImage(options)` - 选择并上传单张图片
- `previewImage(current, urls)` - 预览图片
- `compressImage(src, quality)` - 压缩图片
- `getImageInfo(src)` - 获取图片信息

### 3. 使用示例

```javascript
import { chooseAndUploadSingleImage, previewImage } from '@/utils/upload'

// 上传单张图片
const uploadAvatar = async () => {
  try {
    const url = await chooseAndUploadSingleImage()
    console.log('上传成功', url)
  } catch (error) {
    console.error('上传失败', error)
  }
}

// 上传多张图片
const uploadImages = async () => {
  try {
    const urls = await chooseAndUploadImage({ count: 9 })
    console.log('上传成功', urls)
  } catch (error) {
    console.error('上传失败', error)
  }
}

// 预览图片
const preview = (current, urls) => {
  previewImage(current, urls)
}
```

## 四、数据库配置

在 `system_config` 表中存储相关配置：

```sql
-- 存储类型配置
INSERT INTO `system_config` (`config_key`, `config_value`, `description`) VALUES
('storage_type', 'local', '存储类型：local-本地存储，oss-阿里云OSS'),
('oss_access_key_id', '', '阿里云OSS AccessKeyId'),
('oss_access_key_secret', '', '阿里云OSS AccessKeySecret'),
('oss_endpoint', '', '阿里云OSS Endpoint'),
('oss_bucket_name', '', '阿里云OSS Bucket名称'),
('oss_domain', '', '阿里云OSS访问域名');
```

## 五、部署说明

### 1. 本地存储部署

1. 确保服务器有足够的存储空间
2. 配置文件上传路径（建议使用绝对路径）
3. 配置Nginx静态文件访问：
   ```nginx
   location /files {
       alias /data/mengyo/upload/;
   }
   ```

### 2. 阿里云OSS部署

1. 注册阿里云账号，开通OSS服务
2. 创建Bucket，设置为公共读权限
3. 获取AccessKey（建议使用RAM子账号）
4. 在管理后台配置OSS参数
5. （可选）配置CDN加速和自定义域名

### 3. 注意事项

- 切换存储方式后，需要重启后端服务才能生效
- OSS配置信息请妥善保管，不要泄露AccessKey
- 建议在生产环境使用RAM子账号，并设置最小权限
- 定期检查OSS存储用量，避免产生过高费用
- 建议配置OSS的生命周期规则，自动删除过期文件

## 六、测试说明

### 1. 本地存储测试

1. 启动后端服务
2. 访问管理后台，进入系统配置页面
3. 选择"本地存储"并保存
4. 尝试上传图片/文件
5. 检查文件是否保存在配置的路径
6. 访问返回的URL，确认文件可以正常访问

### 2. OSS存储测试

1. 配置阿里云OSS参数
2. 选择"阿里云OSS"并保存
3. 重启后端服务
4. 尝试上传图片/文件
5. 检查文件是否上传到OSS
6. 访问返回的URL，确认文件可以正常访问

### 3. 功能测试清单

- [ ] 本地存储上传图片
- [ ] 本地存储上传文件
- [ ] 本地存储删除文件
- [ ] OSS上传图片
- [ ] OSS上传文件
- [ ] OSS删除文件
- [ ] 管理后台配置页面
- [ ] 管理后台文件上传组件
- [ ] uni-app端图片上传
- [ ] uni-app端文件上传
- [ ] 存储方式切换功能

## 七、常见问题

### 1. 上传失败

- 检查文件大小是否超过限制
- 检查文件格式是否支持
- 检查网络连接是否正常
- 查看后端日志排查错误

### 2. 文件访问失败

- 本地存储：检查Nginx配置是否正确
- OSS存储：检查Bucket权限设置
- 检查URL是否正确

### 3. OSS配置无效

- 确认已重启后端服务
- 检查AccessKey是否正确
- 检查Endpoint格式是否正确
- 检查Bucket名称是否正确

## 八、安全建议

1. 文件类型校验：严格限制允许上传的文件类型
2. 文件大小限制：防止恶意上传大文件
3. 文件名处理：使用UUID重命名，避免文件名冲突
4. 访问权限：合理设置文件访问权限
5. 敏感信息：AccessKey等敏感信息不要硬编码
6. 定期清理：定期清理无用文件，释放存储空间
